<ion-header class="shadow">
  <ion-toolbar class="ion-text-center">
    <ion-buttons *ngIf="!fromVisit" slot="start" (click)="goBack()">
      <ion-icon size="large" name="arrow-back-outline"></ion-icon>
    </ion-buttons>
    <ion-title>#{{currentCaseData.id}}</ion-title>
    <ion-buttons slot="end">
      <ion-button *ngIf="!fromVisit" size="small" color="secondary" (click)="doRefresh()">
        <ion-icon size="large" name="refresh-circle-outline"></ion-icon>
      </ion-button>
      <ion-button *ngIf="!fromVisit && !fromVrmSearch" size="small" color="secondary" (click)="presentActionSheet()">
        Actions
      </ion-button>
      <ion-button *ngIf="fromVisit" (click)="dismiss()">
        <ion-icon name="close-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">
  <ion-refresher slot="fixed" (ionRefresh)="doRefresh($event)">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>
  <ion-grid>
    <ion-row>
      <ion-col *ngIf="!fromVisit" size-md="8" size-sm="12" size-xs="12">
        <ion-card class="m-0 h-100">
          <ion-card-header>
            <ion-card-subtitle><b>QUICK INFO</b></ion-card-subtitle>
          </ion-card-header>
          <ion-card-content>
            <ion-grid>
              <ion-row>
                <ion-col size-sm="6" size-xs="12">
                  <span class="d-block dark"><b>Debtor Details</b></span>
                  <span class="d-block color-primary">Debtor Name</span>
                  <span class="d-block"><b>{{currentCaseData.debtor?.debtor_name}}</b></span>
                  <hr>
                  <span class="d-block color-primary">Address</span>
                  <span *ngFor="let address of currentCaseData.debtor?.addresses,let i=index">
                    <span class="d-block"><b>{{address.address_ln1}}
                        {{address.address_ln2 ? ', ' +address.address_ln2 : ''}}
                        {{address.address_ln3 ? ', ' +address.address_ln3 : ''}}
                        {{address.address_town ? ', ' +address.address_town : ''}}
                        {{address.address_postcode ? ', ' +address.address_postcode : ''}}</b>
                    </span>
                  </span>
                  <hr>
                  <span class="d-block color-primary">Enforcement Address</span>
                  <span *ngFor="let address of currentCaseData.debtor?.enforcement_addresses,let i=index">
                    <span class="d-block"><b>{{address.address_ln1}}
                        {{address.address_ln2 ? ', ' +address.address_ln2 : ''}}
                        {{address.address_ln3 ? ', ' +address.address_ln3 : ''}}
                        {{address.address_town ? ', ' +address.address_town : ''}}
                        {{address.address_postcode ? ', ' +address.address_postcode : ''}}</b>
                    </span>
                  </span>
                  <hr>
                  <span class="d-block color-primary">Contact</span>
                  <span class="d-block"
                    *ngIf="currentCaseData.debtor?.debtor_mobile"><b>{{currentCaseData.debtor?.debtor_mobile}}</b></span>
                  <span class="d-block"
                    *ngIf="currentCaseData.debtor?.debtor_phone"><b>{{currentCaseData.debtor?.debtor_phone}}</b></span>
                  <hr>
                  <span class="d-block dark mt-15"><b>Offense Details</b></span>
                  <ng-container *ngFor="let data of getCaseSchemeSpecificData">
                    <span class="d-block color-primary">{{data.label}}</span>
                    <span class="d-block"><b>{{data.value ? data.value : '-'}}</b></span>
                    <hr>
                  </ng-container>
                </ion-col>
                <ion-col size-sm="6" size-xs="12">
                  <span class="d-block dark"><b>Case Details</b></span>
                  <span class="d-block color-primary">Client Reference</span>
                  <span class="d-block" *ngIf="isNewlyn"><b>{{caseDetails.data.cl_ref}}</b></span>
                  <span class="d-block" *ngIf="!isNewlyn"><b>{{caseDetails.data.ref}}</b></span>
                  <hr>
                  <span class="d-block color-primary">Client Name</span>
                  <span class="d-block"><b>{{caseDetails.data.client_name}}</b></span>
                  <hr>
                  <span class="d-block color-primary">Scheme</span>
                  <span class="d-block"><b>{{caseDetails.data.scheme_name}}</b></span>
                  <hr>
                  <span class="d-block color-primary">Stage</span>
                  <span class="d-block"><b>{{caseDetails.data.stage_name}}</b></span>
                  <hr>
                  <span class="d-block color-primary">Status</span>
                  <span class="d-block"><b>{{caseDetails.data.status_name}}</b></span>
                  <hr>
                  <span class="d-block color-primary">Last visit date</span>
                  <span class="d-block"><b>{{caseDetails.data.last_visit_date}}</b></span>
                  <hr>
                  <span class="d-block color-primary">VRM</span>
                  <span class="d-block"><b>{{caseDetails.data.custom5}}</b></span>
                  <hr>
                  <span class="d-block color-primary">Warrant Date</span>
                  <span class="d-block" *ngIf="isNewlyn"><b>{{caseDetails.data.custom_date4 ?
                      caseDetails.data.custom_date4 : '-'}}</b></span>
                  <span class="d-block" *ngIf="!isNewlyn"><b>{{caseDetails.data.award_date ? caseDetails.data.award_date
                      : (caseDetails.data.custom_date4 ? caseDetails.data.custom_date4 : '-')}}</b></span>
                  <hr>
                  <span class="d-block color-primary">On Hold</span>
                  <span class="d-block"><b>{{(caseDetails.data.current_status &&
                      caseDetails.data.current_status.status_type == 3) || caseDetails.data.hold_until > currentDate
                      ? 'Yes' : 'No'}}</b></span>
                  <hr>
                  <ng-container
                    *ngIf="(caseDetails.data.current_status && caseDetails.data.current_status.status_type == 3) || caseDetails.data.hold_until > currentDate">
                    <span class="d-block color-primary">Hold Expiry</span>
                    <span class="d-block"><b>{{caseDetails.data.hold_until}}</b></span>
                    <hr>
                  </ng-container>
                  <span class="d-block color-primary">Liability Order Date</span>
                  <span class="d-block"><b>{{caseDetails.data.custom_date5}}</b></span>
                  <hr>
                  <span class="d-block color-primary">Broken Arrangement Count</span>
                  <span class="d-block"><b>{{caseDetails.data.broken_arrangement_count ? caseDetails.data.broken_arrangement_count : '-'}}</b></span>
                  <hr>
                  <ng-container *ngIf="fromVrmSearch">
                    <span class="d-block color-primary">Agent Name</span>
                    <span class="d-block"><b>{{caseDetails.caseSummary.officer?.name}}</b></span>
                    <hr>
                  </ng-container>
                  <span class="d-block dark"><b>Vehicle Details</b></span>
                  <span class="d-block color-primary">Make</span>
                  <span class="d-block"><b>{{caseDetails.case_custom_data.vehicle_make ?
                      caseDetails.case_custom_data.vehicle_make : '-'}}</b></span>
                  <hr>
                  <span class="d-block color-primary">Model</span>
                  <span class="d-block"><b>{{caseDetails.case_custom_data.model ? caseDetails.case_custom_data.model :
                      '-'}}</b></span>
                  <hr>
                  <span class="d-block color-primary">Colour</span>
                  <span class="d-block"><b>{{caseDetails.case_custom_data.colour ? caseDetails.case_custom_data.colour :
                      '-'}}</b></span>
                  <hr>

                </ion-col>
              </ion-row>
            </ion-grid>
          </ion-card-content>
        </ion-card>
      </ion-col>
      <ion-col size-md="4" size-sm="12" size-xs="12">
        <ion-card class="m-0 h-100">
          <ion-card-header>
            <ion-card-subtitle><b>FINANCIALS</b></ion-card-subtitle>
          </ion-card-header>
          <ion-card-content>
            <ion-grid>
              <ion-row>
                <ion-col>
                  <span class="d-block dark"><b>Client</b></span>
                  <span class="list-item-inline"><span class="color-primary">Amount Due</span>
                    <span><b>{{caseDetails.data.d_total_client_owed | number:'0.2-2'}}</b></span>
                  </span>
                  <span class="list-item-inline"><span class="color-primary">Amount Collected</span>
                    <span><b>{{caseDetails.data.d_client_received | number:'0.2-2'}}</b></span>
                  </span>
                  <span class="list-item-inline"><span class="color-primary">Amount Cleared</span>
                    <span><b>{{caseDetails.data.d_client_cleared | number:'0.2-2'}}</b></span>
                  </span>
                  <span class="list-item-inline"><span class="color-primary">Amount Paid Out</span>
                    <span><b>{{caseDetails.data.d_client_paid | number:'0.2-2'}}</b></span>
                  </span>
                  <span class="list-item-inline"><span class="color-primary">Amount Outstanding</span>
                    <span><b>{{caseDetails.data.d_clientbalance | number:'0.2-2'}}</b></span>
                  </span>
                  <!-- ------------------------------------------------------------------------------------------------------------- -->
                  <hr>
                  <span class="d-block dark mt-15"><b>Fees (inc. vat)</b></span>
                  <span class="list-item-inline"><span class="color-primary">Amount Due</span>
                    <span><b>{{caseDetails.data.d_total_fees_owed | number:'0.2-2'}}</b></span>
                  </span>
                  <span class="list-item-inline"><span class="color-primary">Fees Collected </span>
                    <span><b>{{caseDetails.data.d_fees_received | number:'0.2-2'}}</b></span>
                  </span>
                  <span class="list-item-inline"><span class="color-primary">Fees Cleared</span>
                    <span><b>{{caseDetails.data.d_fees_cleared | number:'0.2-2'}}</b></span>
                  </span>
                  <span class="list-item-inline"><span class="color-primary">Fees Paid Out </span>
                    <span><b>{{caseDetails.data.d_fees_paid | number:'0.2-2'}}</b></span>
                  </span>
                  <span class="list-item-inline"><span class="color-primary">Fee outstanding</span>
                    <span><b>{{caseDetails.data.d_feesbalance | number:'0.2-2'}}</b></span>
                  </span>
                  <hr>
                  <!-- ------------------------------------------------------------------------------------------------------------- -->
                  <span class="d-block dark mt-15"><b>Total (inc. client, fees and vat)</b></span>
                  <span class="list-item-inline"><span class="color-primary">Amount Due</span>
                    <span><b>{{sum(caseDetails.data.d_total_client_owed, caseDetails.data.d_total_fees_owed) |
                        number:'0.2-2'}}</b></span>
                  </span>
                  <span class="list-item-inline"><span class="color-primary">Amount Collected</span>
                    <span><b>{{sum(caseDetails.data.d_client_received, caseDetails.data.d_fees_received) |
                        number:'0.2-2'}}</b></span>
                  </span>
                  <span class="list-item-inline"><span class="color-primary">Amount Cleared</span>
                    <span><b>{{sum(caseDetails.data.d_client_cleared, caseDetails.data.d_fees_cleared) |
                        number:'0.2-2'}}</b></span>
                  </span>
                  <span class="list-item-inline"><span class="color-primary">Amount Paid Out </span>
                    <span><b>{{sum(caseDetails.data.d_client_paid, caseDetails.data.d_fees_paid) |
                        number:'0.2-2'}}</b></span>
                  </span>
                  <span class="list-item-inline"><span class="color-primary">Current outstanding</span>
                    <span><b>{{sum(caseDetails.data.d_clientbalance, caseDetails.data.d_feesbalance) |
                        number:'0.2-2'}}</b></span>
                  </span>
                  <!-- ------------------------------------------------------------------------------------------------------------- -->
                  <ng-container *ngIf="currentCaseData.linked_cases && currentCaseData.linked_cases.length">
                    <hr>
                    <span class="d-block dark mt-15"><b>Linked Cases</b></span>
                    <span class="list-item-inline">
                      <span>Case Id</span>
                      <span>Outstanding</span>
                    </span>
                    <span class="list-item-inline" *ngFor="let linked_case of currentCaseData.linked_cases">
                      <span class="color-primary">{{linked_case.id}}</span>
                      <span><b>
                          {{linked_case.d_outstanding | number:'0.2-2'}}
                        </b></span>
                    </span>
                  </ng-container>
                </ion-col>
              </ion-row>
            </ion-grid>
          </ion-card-content>
        </ion-card>
      </ion-col>
      <ion-col size-md="12" size="12">
        <ion-card class="m-0 h-100">
          <ion-card-content>
            <ion-list class="ion-no-border ion-margin-start" [hidden]="!caseMarkers.length">
              <ion-button (click)="onCaseMarkerClick(caseMarker)" size="default"
                [color]="colorCondition(caseMarker.value)" *ngFor="let caseMarker of caseMarkers">
                {{caseMarker.label}}
              </ion-button>
            </ion-list>
          </ion-card-content>
        </ion-card>
      </ion-col>
      <ion-col *ngIf="!fromVisit" size-md="12">
        <ion-card class="m-0 h-100">
          <ion-card-header>
            <ion-grid class="ion-no-padding">
              <ion-row>
                <ion-col class="ion-no-padding">
                  <ion-card-subtitle><b>HISTORY</b></ion-card-subtitle>
                </ion-col>
              </ion-row>
              <ion-row>
                <ion-col class="ion-no-padding" size-md="4" size="12">
                  <ion-searchbar class="p-y-0 p-x-0" [value]="searchBarValue" [(ngModel)]="historyName"
                    placeholder="Search note, name..">
                  </ion-searchbar>
                </ion-col>
                <ion-col class="ion-no-padding" size-md="4" size="12">
                  <ion-item>
                    <ion-label>Action</ion-label>
                    <ion-select multiple="true" cancelText="Cancel" okText="Okay" placeholder="Action"
                      [(ngModel)]="historyAction">
                      <ion-select-option *ngFor="let historyType of historyTypes" [value]="historyType">
                        {{historyType}}
                      </ion-select-option>
                    </ion-select>
                  </ion-item>
                </ion-col>
                <ion-col class="ion-no-padding ion-text-end" size-md="4" size="12">
                  <ion-button size="small" color="secondary" (click)="filterHistory()">Search</ion-button>
                </ion-col>
              </ion-row>
            </ion-grid>
          </ion-card-header>
          <ion-card-content *ngIf="!dataReady">
            Downloading History Data
          </ion-card-content>
          <ion-card-content *ngIf="dataReady">
            <ion-grid class="ion-no-padding">
              <ion-row class="border-bottom" *ngFor="let history of historyFilterData">
                <ion-col size-md="8" size="12">
                  <span class="d-block color-primary">{{history.action}}</span>
                </ion-col>
                <ion-col size-md="4" size="12">
                  <span class="d-block d-block-right">{{history.time + 'Z' | date:'yyyy-MM-dd HH:mm:ss' }}</span>
                </ion-col>
                <ion-col size-md="12" size="12" *ngIf="history.name && history.name != 'null'">
                  <span class="d-block d-block-right">{{history.name}}</span>
                </ion-col>
                <ion-col size-md="12" size="12" *ngIf="history.note">
                  <span [innerHtml]="history.note"></span>
                </ion-col>
                <ion-col size-md="12" size="12"
                  *ngIf="history.attachment || (history.type == 'EA Added Visit Form' && history.document_id > 0)">
                  <ion-button *ngIf="history.attachment" size="small" color="secondary">
                    <a [href]="history.attachment" target="_blank" class="white-link">Download Attachment</a>
                  </ion-button>
                  <ion-button *ngIf="history.type == 'EA Added Visit Form' && history.document_id > 0" size="small"
                    color="secondary" (click)='showVisitDetails(history)'>Visit Details</ion-button>
                </ion-col>
              </ion-row>
            </ion-grid>
            <ion-infinite-scroll threshold="100px" id="infinite-scroll" (ionInfinite)="loadData($event)">
              <ion-infinite-scroll-content loading-spinner="bubbles" loading-text="Loading more data...">
              </ion-infinite-scroll-content>
            </ion-infinite-scroll>
          </ion-card-content>
        </ion-card>
      </ion-col>
    </ion-row>
  </ion-grid>

</ion-content>